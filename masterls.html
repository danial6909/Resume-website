<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Mastermind Solver - Step-by-Step Simulated Annealing</title>
    <style>
        :root {
            --bg: #f0f2f5;
            --panel: #ffffff;
            --primary: #3498db;
        }
        body { font-family: Tahoma, sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .card { background: var(--panel); padding: 25px; border-radius: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); width: 450px; text-align: center; }
        
        .peg-row { display: flex; justify-content: center; gap: 10px; margin: 15px 0; }
        .peg { 
            width: 40px; height: 40px; border-radius: 50%; border: 3px solid #ddd; 
            cursor: pointer; transition: 0.2s; box-shadow: inset 0 -3px 5px rgba(0,0,0,0.2);
        }
        
        button { 
            background: #e74c3c;
            color: white; border: none; padding: 12px 25px; 
            border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; width: 100%;
        }
        button:hover { background: #c0392b; }
        button:disabled { background: #bdc3c7; }

        .status-box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #eee; }
        #history { max-height: 300px; overflow-y: auto; margin-top: 15px; padding-right: 5px; }
        .h-row { 
            display: flex; justify-content: space-between; padding: 8px; 
            border-bottom: 1px solid #f1f1f1; align-items: center; background: #fff; margin-bottom: 5px; border-radius: 5px;
        }
        .s-peg { width: 18px; height: 18px; border-radius: 50%; display: inline-block; margin: 0 2px; border: 1px solid #ccc; }
        .feedback-icons { font-size: 12px; color: #555; text-align: right; }
        .attempt-tag { background: #e67e22; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; }
    </style>
</head>
<body>

<div class="card">
    <h2>Ø­Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø¨Ø§ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø­Ù„ÛŒ (SA)</h2>
    <p style="font-size: 0.85rem; color: #666;">**Ø±ÙˆØ´:** Ø§Ù„Ú¯ÙˆØ±ÛŒØªÙ… ØªØ¨Ø±ÛŒØ¯ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒâ€ŒØ´Ø¯Ù‡. Ù‡Ø± Ø­Ø±Ú©Øª Ù¾Ø°ÛŒØ±ÙØªÙ‡â€ŒØ´Ø¯Ù‡ Ø«Ø¨Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>

    <div class="peg-row" id="target-ui">
        <div class="peg" data-id="0"></div>
        <div class="peg" data-id="1"></div>
        <div class="peg" data-id="2"></div>
        <div class="peg" data-id="3"></div>
    </div>

    <button id="run-btn">Ø´Ø±ÙˆØ¹ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø­Ù„ÛŒ</button>

    <div class="status-box">
        <div>Ø¯Ù…Ø§: <span id="temp-out">0</span> | Ù¾ÛŒÙ†â€ŒÙ‡Ø§ÛŒ ØµØ­ÛŒØ­ (Ù…Ø´Ú©ÛŒ): <span id="black-out">0</span></div>
        <div class="peg-row" id="guess-ui" style="margin: 10px 0;">
            <div class="peg" style="width:30px; height:30px; cursor:default;"></div>
            <div class="peg" style="width:30px; height:30px; cursor:default;"></div>
            <div class="peg" style="width:30px; height:30px; cursor:default;"></div>
            <div class="peg" style="width:30px; height:30px; cursor:default;"></div>
        </div>
        <div id="stat-text" style="font-size:0.9rem;">Ø¢Ù…Ø§Ø¯Ù‡...</div>
    </div>

    <div id="history"></div>
</div>

<script>
    const PALETTE = ['#e74c3c', '#2ecc71', '#3498db', '#f1c40f']; // Ù‚Ø±Ù…Ø²ØŒ Ø³Ø¨Ø²ØŒ Ø¢Ø¨ÛŒØŒ Ø²Ø±Ø¯
    let target = [0, 1, 2, 3];
    let running = false;
    let stepCount = 0; // Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ú¯Ø§Ù…â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ (Ø­Ø±Ú©Øª Ù¾Ø°ÛŒØ±ÙØªÙ‡â€ŒØ´Ø¯Ù‡)

    // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù‡Ø¯Ù
    const tPegs = document.querySelectorAll('#target-ui .peg');
    tPegs.forEach((p, i) => {
        p.style.backgroundColor = PALETTE[target[i]];
        p.onclick = () => {
            if(running) return;
            target[i] = (target[i] + 1) % 4; 
            p.style.backgroundColor = PALETTE[target[i]];
        };
    });

    // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ ÙÛŒØ¯Ø¨Ú©
    function getFeedback(guess, actual) {
        let black = 0;
        let white = 0;
        let gCopy = [...guess];
        let aCopy = [...actual];

        // Black Pins
        for (let i = 0; i < 4; i++) {
            if (gCopy[i] === aCopy[i]) {
                black++;
                gCopy[i] = aCopy[i] = null;
            }
        }
        
        // White Pins
        for (let i = 0; i < 4; i++) {
            if (gCopy[i] !== null) {
                let foundIdx = aCopy.indexOf(gCopy[i]);
                if (foundIdx !== -1) {
                    white++;
                    aCopy[foundIdx] = null;
                }
            }
        }
        return { black, white };
    }

    // ØªØ§Ø¨Ø¹ Energy/Cost (4 - Black Pins)
    function getEnergy(code) {
        return 4 - getFeedback(code, target).black;
    }

    async function solve() {
        running = true;
        document.getElementById('run-btn').disabled = true;
        document.getElementById('history').innerHTML = '';
        stepCount = 0;
        
        // State Ø§ÙˆÙ„ÛŒÙ‡
        let current = [0, 0, 0, 0].map(() => Math.floor(Math.random() * 4));
        let curEnergy = getEnergy(current);
        let T = 10.0;
        const cooling = 0.90;

        const gPegs = document.querySelectorAll('#guess-ui .peg');
        const MAX_ATTEMPTS = 250; 
        let internalAttempts = 0;

        // Ø«Ø¨Øª ÙˆØ¶Ø¹ÛŒØª Ø´Ø±ÙˆØ¹
        let fbStart = getFeedback(current, target);
        log(current, fbStart, 0, true);
        
        while (T > 0.001 && curEnergy > 0 && internalAttempts < MAX_ATTEMPTS) {
            internalAttempts++;
            
            // 1. Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ù…Ø³Ø§ÛŒÙ‡
            let next = [...current];
            next[Math.floor(Math.random() * 4)] = Math.floor(Math.random() * 4);
            let nextEnergy = getEnergy(next);
            
            let delta = nextEnergy - curEnergy;
            
            // 2. Ù‚Ø§Ù†ÙˆÙ† Ù¾Ø°ÛŒØ±Ø´ Simulated Annealing
            if (delta < 0 || Math.random() < Math.exp(-delta / T)) {
                
                // --- Ø­Ø±Ú©Øª Ù¾Ø°ÛŒØ±ÙØªÙ‡ Ø´Ø¯ ---
                current = next;
                curEnergy = nextEnergy;
                stepCount++;
                
                // 3. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI Ùˆ Ø«Ø¨Øª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
                let fb = getFeedback(current, target);
                log(current, fb, stepCount, false); // Ø«Ø¨Øª Ù…Ø±Ø­Ù„Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ù„Ø§Ú¯
            }

            // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ
            document.getElementById('temp-out').innerText = T.toFixed(3);
            document.getElementById('black-out').innerText = (4 - curEnergy);
            document.getElementById('stat-text').innerText = `ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ SA: ${internalAttempts}`;
            gPegs.forEach((p, i) => p.style.backgroundColor = PALETTE[current[i]]);
            

            await new Promise(r => setTimeout(r, 100)); // Ú©Ø§Ù‡Ø´ Ø³Ø±Ø¹Øª Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ù…Ø±Ø§Ø­Ù„
            T *= cooling;
        }

        if(curEnergy === 0) {
             alert(`ğŸ‰ Ù…ÙˆÙÙ‚ÛŒØª! Ú©Ø¯ Ø¯Ø± ${stepCount} Ú¯Ø§Ù… Ù¾Ø°ÛŒØ±ÙØªÙ‡â€ŒØ´Ø¯Ù‡ ØªÙˆØ³Ø· SA Ù¾ÛŒØ¯Ø§ Ø´Ø¯.`);
        } else {
            alert(`â›” Ø´Ú©Ø³Øª. Ù¾Ø³ Ø§Ø² ${internalAttempts} ØªÙ„Ø§Ø´ØŒ Ú©Ø¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. (Ø¢Ø®Ø±ÛŒÙ† Ø®Ø·Ø§: ${curEnergy})`);
        }
        
        running = false;
        document.getElementById('run-btn').disabled = false;
    }

    function log(code, fb, step, isStart) {
        const h = document.getElementById('history');
        const row = document.createElement('div');
        row.className = 'h-row';
        let pegs = code.map(c => `<div class="s-peg" style="background:${PALETTE[c]}"></div>`).join('');
        
        const tagText = isStart ? "Ø´Ø±ÙˆØ¹" : `Ú¯Ø§Ù… ${step}`;
        const tagColor = isStart ? "#3498db" : "#e67e22";

        row.innerHTML = `
            <div><span class="attempt-tag" style="background:${tagColor}">${tagText}</span> ${pegs}</div>
            <div class="feedback-icons">
                âœ… Ù…Ø´Ú©ÛŒ (Ø¬Ø§ÛŒ Ø¯Ø±Ø³Øª): **${fb.black}** <br> 
                ğŸ¨ Ø³ÙÛŒØ¯ (Ø±Ù†Ú¯ Ø¯Ø±Ø³Øª): **${fb.white}**
            </div>
        `;
        h.prepend(row);
        // Ø§Ø³Ú©Ø±ÙˆÙ„ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ø¢Ø®Ø±ÛŒÙ† Ø­Ø±Ú©Øª
        h.scrollTop = 0; 
    }

    document.getElementById('run-btn').onclick = solve;
</script>
</body>
</html>